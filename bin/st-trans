#!/bin/bash

# Selected text translator by ibrahim mohammad
# Email: ibrahim.mohammad.2015@gmail.com
# GitHub repository: https://github.com/IbrahimMohammad/shell_script
# No Rights Reserved

help () {
    echo -e "Usage: st-trans [<OPTIONS>|<[SOURCE]:[TARGET]>]

Options:
    -l\t\tshow a list of supported languages and codes.

    -k\t\tchange shortcut key.

    -h\t\tprint this help and exit.

    -t\t\tspecifies the timeout in seconds at which to expire the translator notifications.

    -u\t\tspecifies translator notifications urgency level (low, normal, critical) in integers (0, 1, 2) respectively.

    -v\t\tinvert source language with target language. note: you can't use this option when source language set to auto.

    -c\t\trun st-trans in command mode, translate selection when shortcut key pressed (defalt mode).

    -i\t\trun st-trans in instant translation mode, translate selection instantly.

    -U\t\tupdate st-trans to latest version.

    -R\t\treinstall st-trans and reset default preferneces.

Language preferences
[SOURCE]:[TARGET]
To change source and target language use
SOURCE-CODE:TARGET-CODE
For example to translate from English to French use this command
st-trans en:fr

Also you can change just one language either source by
SOURCE:
For example
st-trans en:
or target
:TARGET
For example
st-trans :fr
You can use auto as the source language to auto detect source language
st-trans auto:"
}

if [ -n "$1" ]; then # options
    # print languages table
    if [ "$1" == "-l" ]; then
        echo "┌──────────────────────┬───────────────────────┬───────────────────────┐
│Language Name    Code │Language Name     Code │Language Name     Code │ 
│──────────────────────│───────────────────────│───────────────────────│ 
│ Afrikaans      - af  │ Hawaiian        - haw │ Portuguese      - pt  │ 
│ Albanian       - sq  │ Hebrew          - he  │ Punjabi         - pa  │ 
│ Amharic        - am  │ Hindi           - hi  │ Romanian        - ro  │ 
│ Arabic         - ar  │ Hmong           - hmn │ Romansh         - rm  │ 
│ Armenian       - hy  │ Hungarian       - hu  │ Russian         - ru  │ 
│ Assamese       - as  │ Icelandic       - is  │ Samoan          - sm  │ 
│ Azerbaijani    - az  │ Igbo            - ig  │ Scottish Gaelic - gd  │ 
│ Bashkir        - ba  │ Indonesian      - id  │ Serbian         - sr  │ 
│ Basque         - eu  │ Interlingue     - ie  │ Sesotho         - st  │ 
│ Belarusian     - be  │ Irish           - ga  │ Shona           - sn  │ 
│ Bengali        - bn  │ Italian         - it  │ Sindhi          - sd  │ 
│ Bosnian        - bs  │ Japanese        - ja  │ Sinhala         - si  │ 
│ Breton         - br  │ Javanese        - jv  │ Slovak          - sk  │ 
│ Bulgarian      - bg  │ Kannada         - kn  │ Slovenian       - sl  │ 
│ Catalan        - ca  │ Kazakh          - kk  │ Somali          - so  │ 
│ Cebuano        - ceb │ Khmer           - km  │ Spanish         - es  │ 
│ Cherokee       - chr │ Kinyarwanda     - rw  │ Sundanese       - su  │ 
│ Chichewa       - ny  │ Korean          - ko  │ Swahili         - sw  │ 
│ Chinese Simp.  - zh-CN Kurdish         - ku  │ Swedish         - sv  │ 
│ Chinese Trad.  - zh-TW Kyrgyz          - ky  │ Tajik           - tg  │ 
│ Corsican       - co  │ Lao             - lo  │ Tamil           - ta  │ 
│ Croatian       - hr  │ Latin           - la  │ Tatar           - tt  │ 
│ Czech          - cs  │ Latvian         - lv  │ Telugu          - te  │ 
│ Danish         - da  │ Lithuanian      - lt  │ Thai            - th  │ 
│ Dutch          - nl  │ Luxembourgish   - lb  │ Tibetan         - bo  │ 
│ Dzongkha       - dz  │ Macedonian      - mk  │ Tigrinya        - ti  │ 
│ English        - en  │ Malagasy        - mg  │ Turkish         - tr  │ 
│ Esperanto      - eo  │ Malay           - ms  │ Turkmen         - tk  │ 
│ Estonian       - et  │ Malayalam       - ml  │ Ukrainian       - uk  │ 
│ Faroese        - fo  │ Maltese         - mt  │ Urdu            - ur  │ 
│ Fijian         - fj  │ Maori           - mi  │ Uyghur          - ug  │ 
│ Filipino       - tl  │ Marathi         - mr  │ Uzbek           - uz  │ 
│ Finnish        - fi  │ Mongolian       - mn  │ Vietnamese      - vi  │ 
│ French         - fr  │ Myanmar         - my  │ Volapük         - vo  │ 
│ Galician       - gl  │ Nepali          - ne  │ Welsh           - cy  │ 
│ Georgian       - ka  │ Norwegian       - no  │ Western Frisian - fy  │ 
│ German         - de  │ Occitan         - oc  │ Wolof           - wo  │ 
│ Greek          - el  │ Oriya           - or  │ Xhosa           - xh  │ 
│ Guarani        - gn  │ Oromo           - om  │ Yiddish         - yi  │ 
│ Gujarati       - gu  │ Pashto          - ps  │ Yoruba          - yo  │ 
│ Haitian Creole - ht  │ Persian         - fa  │ Zulu            - zu  │ 
│ Hausa          - ha  │ Polish          - pl  │                       │
└──────────────────────┴───────────────────────┴───────────────────────┘"
    # change languages
    elif echo "$1" | grep -qF ':'; then
        curr_source_lang="$(cut -sd \& -f 2 ~/.st-trans)"
        curr_target_lang="$(cut -sd \& -f 3 ~/.st-trans)"
        new_source_lang="$(echo "$1" | cut -sd \: -f 1)"
        new_target_lang="$(echo "$1" | cut -sd \: -f 2)"
        # is there are a source language?
		if [ -n "$new_source_lang" ]; then
            # check language code
            if ! grep -q "\- $new_source_lang " /usr/bin/st-trans  &&  [ "$new_source_lang" != "auto" ]; then
                    echo "\"$new_source_lang\" isn't a supported language code. please take a look at language table with st-trans -l"
                    exit 1
            fi
            # change source language
            sed -i "s/$curr_source_lang/sl=$new_source_lang/" ~/.st-trans
		fi
        # is there are a target language?
		if [ -n "$new_target_lang" ]; then
            # check language code
            if ! grep -q "\- $new_target_lang " /usr/bin/st-trans  ; then
                echo "\"$new_target_lang\" isn't a supported language code. please take a look at supported language table with st-trans -l"
                exit 1
            fi
            # change target language
            sed -i "s/$curr_target_lang/tl=$new_target_lang/" ~/.st-trans
		fi
    # change shortcut key
    elif [ "$1" == "-k" ]; then
        echo "Please press combination of keys to set your new shortcut key"
        new_key="$(xbindkeys -k | sed -n '$p')"
        # check if user enter new shortcut key
        if [ "$new_key" == 'in $HOME/.xbindkeysrc to bind a key.' ]; then
            echo "nothing change"
        else
            curr_key="$(sed -n '/\~\/\.st-trans/{n;p;}' ~/.xbindkeysrc)"
            sed -i "s/$curr_key/$new_key/" ~/.xbindkeysrc
            xbindkeys
        fi	
    # invert source language with target language
    elif [ "$1" == "-v" ]; then
        curr_source_lang_code="$(cut -sd \& -f 2 ~/.st-trans | cut -sd \= -f 2)" # only language code without "sl="
        if [ "$curr_source_lang_code" == "auto" ]; then
            notify-send -t 0 -u critical "Source language set to auto so i can't invert it." "Please change source language to any supported language so i can invert it for you."
            exit 1
        fi
        curr_target_lang_code="$(cut -sd \& -f 3 ~/.st-trans | cut -sd \= -f 2)" # only language code without "tl="
        # invert
        sed -i -e "s/sl=$curr_source_lang_code/sl=$curr_target_lang_code/" -e "s/tl=$curr_target_lang_code/tl=$curr_source_lang_code/" ~/.st-trans
    # change timeout period
    elif [ "$1" == "-t" ]; then
        # ensure that $2 exist
        if ! [ -n "$2" ]; then
            help
            exit 1
        fi
        # check that $2 is integer
        if ! [ "$2" -eq "$2" ] &> /dev/null; then
            echo 'Sorry integers only.'
            exit 1
        fi
        curr_timeout=$(tail -n 1 ~/.st-trans | cut -sd ' ' -f 5)
        new_timeout=$(($2*1000))
        sed -i "s/$curr_timeout/$new_timeout/" ~/.st-trans
    # change urgency level:
    elif [ "$1" == "-u" ]; then
		# ensure that $2 exist
        if ! [ -n "$2" ]; then
            help
            exit 1
        fi
		# check that $2 is integer
        if ! [ "$2" -eq "$2" ] &> /dev/null; then
            echo "Sorry integers only"
            exit 1
        fi
        case $2 in
            0)  new_level='low'
                ;;
            1)  new_level='normal'
                ;;
            2)  new_level='critical'
                ;;
            *)  echo "invalid number."
                help
                exit 1
                ;;
        esac
        curr_level=$(tail -n 1 ~/.st-trans | cut -sd ' ' -f 3)
        sed -i "s/$curr_level/$new_level/" ~/.st-trans
    # instant translation mode
    elif [ "$1" == "-i" ]; then
        # check if the daemon already running if not run it
        if pgrep -l st-trans-daemon &> /dev/null; then
	        echo 'Instant translation mode already running.'
	    else
	        setsid st-trans-daemon &> /dev/null < /dev/null&
            echo 'Instant translation mode activated.'
	    fi
    # command mode
    elif [ "$1" == "-c" ]; then
        if killall st-trans-daemon &> /dev/null; then
	        echo 'Command mode activated.'
	    else
	        echo 'Command mode already running.'
	    fi

    #Update st-trans option
    elif [ "$1" == "-U" ] || [ "$1" == "-R" ]; then
        echo "Updating..."
        echo "Downloading the latest version of installer..."
        #determine OS
        if cat /usr/lib/os-release | grep -qF 'debian'; then
            wget --show-progress -qO  ~/st-trans 'https://goo.gl/H64pZP' && chmod 755 ~/st-trans
        fi
        if cat /usr/lib/os-release | grep -qF 'fedora'; then 
            wget --show-progress -qO ~/st-trans 'https://goo.gl/dcgJEe' && chmod 755 ~/st-trans
        fi
        if cat /usr/lib/os-release | grep -qF 'arch'; then
            wget --show-progress -qO ~/st-trans 'https://goo.gl/nqF6vx' && chmod 755 ~/st-trans
        fi
        echo "Need to get super privileges:"

        if [ "$1" == "-R" ]; then
            sudo ~/st-trans --reset
            exit
        fi
        sudo ~/st-trans
    # show help option
    elif [ "$1" == "-h" ]; then
    help
    # more options with elif
    else
    help
    exit 1
    fi
else
help
fi
